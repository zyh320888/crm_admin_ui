<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼˜é›…å¥³è£…ç²¾å“åº—</title>
  
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "@tanstack/react-query": "https://esm.sh/@tanstack/react-query@5.67.1",
        "axios": "https://esm.sh/axios@1.6.2",
        "@d8d-appcontainer/api": "https://esm.sh/@d8d-appcontainer/api@3.0.39"
      }
    }
  </script>
  
  <script type="module" src="https://esm.sh/run"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* è‡ªå®šä¹‰æ ·å¼ */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      padding: 1rem;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }

    /* è½®æ’­å›¾æ ·å¼ */
    .carousel {
      position: relative;
      overflow: hidden;
    }
    
    .carousel-inner {
      white-space: nowrap;
      transition: transform 0.3s;
    }
    
    .carousel-item {
      display: inline-block;
      width: 100%;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loader {
      border-top-color: #e879f9;
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }
    @-webkit-keyframes spinner {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
    .page-enter {
      opacity: 0;
      transform: translateX(100%);
    }
    .page-enter-active {
      opacity: 1;
      transform: translateX(0);
      transition: opacity 300ms, transform 300ms;
    }
    .page-exit {
      opacity: 1;
      transform: translateX(0);
    }
    .page-exit-active {
      opacity: 0;
      transform: translateX(-100%);
      transition: opacity 300ms, transform 300ms;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    import React, { useState, useEffect, useCallback } from 'react';
    import { createRoot } from 'react-dom/client';
    import { QueryClient, QueryClientProvider, useQuery, useMutation } from '@tanstack/react-query';
    import { APIClient } from '@d8d-appcontainer/api';

    const queryClient = new QueryClient();
    let apiClient = null;

    const getApiClient = async () => {
      if (!apiClient) {
        apiClient = await APIClient.getInstance({
          scope: 'user',
          config: {
            serverUrl: 'https://app-server.d8d.fun',
            workspaceKey: 'ws_mphxpy6prf9',
            type: 'http'
          }
        });
      }
      return apiClient;
    };

    // åˆå§‹åŒ–æ•°æ®åº“
    const initDatabase = async () => {
      const apiClient = await getApiClient();
      try {
        // åˆ›å»ºå•†å“è¡¨
        await apiClient.database.schema.createTable('products', (table) => {
          table.increments('id').primary();
          table.string('name').notNullable();
          table.decimal('price', 10, 2).notNullable();
          table.string('image').notNullable();
          table.text('description');
          table.string('category');
          table.boolean('isRecommended').defaultTo(false);
          table.timestamps(true, true);
        });

        // åˆ›å»ºè´­ç‰©è½¦è¡¨
        await apiClient.database.schema.createTable('cart_items', (table) => {
          table.increments('id').primary();
          table.integer('product_id').notNullable();
          table.integer('quantity').notNullable().defaultTo(1);
          table.timestamps(true, true);
        });

        // æ’å…¥ç¤ºä¾‹æ•°æ®
        await apiClient.database.insert('products', [
          {
            name: 'ä¼˜é›…è¿è¡£è£™',
            price: 299.00,
            image: 'https://images.unsplash.com/photo-1515372039744-b8f02a3ae446',
            description: 'æ˜¥å­£æ–°æ¬¾æ·‘å¥³è¿è¡£è£™ï¼Œé‡‡ç”¨ä¼˜è´¨é¢æ–™ï¼Œç©¿ç€èˆ’é€‚ï¼Œçªæ˜¾ä¼˜é›…æ°”è´¨ã€‚',
            category: 'è¿è¡£è£™',
            isRecommended: true
          },
          {
            name: 'æ—¶å°šåŠèº«è£™',
            price: 199.00,
            image: 'https://images.unsplash.com/photo-1583496661160-fb5886a0aaaa',
            description: 'é«˜è…°Aå­—è£™ï¼Œä¿®èº«æ˜¾ç˜¦ï¼Œç™¾æ­æ¬¾å¼ã€‚',
            category: 'è£™è£…',
            isRecommended: true
          },
          {
            name: 'ä¼‘é—²é˜”è…¿è£¤',
            price: 259.00,
            image: 'https://images.unsplash.com/photo-1509551388413-e18d0ac5d495',
            description: 'èˆ’é€‚é˜”è…¿è£¤ï¼Œè‡ªç„¶å‚å ï¼Œæ—¶å°šç™¾æ­ã€‚',
            category: 'è£¤è£…',
            isRecommended: false
          },
          {
            name: 'æ°”è´¨è¡¬è¡«',
            price: 189.00,
            image: 'https://images.unsplash.com/photo-1598554747436-c9293d6a588f',
            description: 'ç®€çº¦æ°”è´¨è¡¬è¡«ï¼ŒèŒåœºå¿…å¤‡ã€‚',
            category: 'ä¸Šè£…',
            isRecommended: true
          }
        ]);
      } catch (error) {
        console.log('è¡¨å·²å­˜åœ¨æˆ–å…¶ä»–é”™è¯¯:', error);
      }
    };

    // è½®æ’­å›¾ç»„ä»¶
    const Carousel = ({ items }) => {
      const [currentIndex, setCurrentIndex] = useState(0);

      useEffect(() => {
        const timer = setInterval(() => {
          setCurrentIndex((prevIndex) => (prevIndex + 1) % items.length);
        }, 3000);
        return () => clearInterval(timer);
      }, [items.length]);

      return (
        <div className="carousel h-64 mb-4">
          <div 
            className="carousel-inner h-full"
            style={{ transform: `translateX(-${currentIndex * 100}%)` }}
          >
            {items.map((item, index) => (
              <div key={index} className="carousel-item h-full">
                <img 
                  src={item.image} 
                  alt={item.name}
                  className="w-full h-full object-cover"
                />
                <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-2">
                  <p className="text-lg">{item.name}</p>
                  <p className="text-sm text-pink-300">Â¥{item.price}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // å•†å“å¡ç‰‡ç»„ä»¶
    const ProductCard = ({ product, onProductClick }) => (
      <div 
        className="bg-white rounded-lg shadow overflow-hidden"
        onClick={() => onProductClick(product)}
      >
        <img 
          src={product.image} 
          alt={product.name}
          className="w-full h-48 object-cover"
        />
        <div className="p-4">
          <h3 className="text-lg font-semibold text-gray-800">{product.name}</h3>
          <p className="text-pink-500 font-bold mt-2">Â¥{product.price}</p>
          <button 
            className="w-full mt-2 bg-pink-500 text-white py-2 rounded-lg hover:bg-pink-600"
            onClick={(e) => {
              e.stopPropagation();
              // æ·»åŠ åˆ°è´­ç‰©è½¦çš„é€»è¾‘å°†åœ¨CartContextä¸­å®ç°
            }}
          >
            åŠ å…¥è´­ç‰©è½¦
          </button>
        </div>
      </div>
    );

    // åˆ†ç±»é¡µé¢
    const CategoryPage = ({ products }) => {
      const categories = [...new Set(products.map(p => p.category))];
      const [selectedCategory, setSelectedCategory] = useState(categories[0]);

      return (
        <div className="pb-16">
          <div className="bg-white p-4 overflow-x-auto">
            <div className="flex space-x-4">
              {categories.map(category => (
                <button
                  key={category}
                  className={`px-4 py-2 rounded-full ${
                    selectedCategory === category 
                      ? 'bg-pink-500 text-white' 
                      : 'bg-gray-100 text-gray-600'
                  }`}
                  onClick={() => setSelectedCategory(category)}
                >
                  {category}
                </button>
              ))}
            </div>
          </div>
          <div className="product-grid">
            {products
              .filter(p => p.category === selectedCategory)
              .map(product => (
                <ProductCard key={product.id} product={product} />
              ))
            }
          </div>
        </div>
      );
    };

    // è´­ç‰©è½¦ä¸Šä¸‹æ–‡
    const CartContext = React.createContext();

    const CartProvider = ({ children }) => {
      const [cartItems, setCartItems] = useState([]);

      const addToCart = useCallback((product) => {
        setCartItems(prev => {
          const existingItem = prev.find(item => item.product_id === product.id);
          if (existingItem) {
            return prev.map(item =>
              item.product_id === product.id
                ? { ...item, quantity: item.quantity + 1 }
                : item
            );
          }
          return [...prev, { product_id: product.id, quantity: 1, product }];
        });
      }, []);

      const removeFromCart = useCallback((productId) => {
        setCartItems(prev => prev.filter(item => item.product_id !== productId));
      }, []);

      const updateQuantity = useCallback((productId, quantity) => {
        setCartItems(prev =>
          prev.map(item =>
            item.product_id === productId
              ? { ...item, quantity: Math.max(0, quantity) }
              : item
          ).filter(item => item.quantity > 0)
        );
      }, []);

      return (
        <CartContext.Provider value={{ cartItems, addToCart, removeFromCart, updateQuantity }}>
          {children}
        </CartContext.Provider>
      );
    };

    // è´­ç‰©è½¦é¡µé¢
    const CartPage = () => {
      const { cartItems, updateQuantity, removeFromCart } = React.useContext(CartContext);
      const total = cartItems.reduce((sum, item) => sum + item.product.price * item.quantity, 0);

      return (
        <div className="pb-16">
          <div className="bg-white p-4">
            <h2 className="text-xl font-bold mb-4">è´­ç‰©è½¦</h2>
            {cartItems.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                è´­ç‰©è½¦æ˜¯ç©ºçš„
              </div>
            ) : (
              <>
                {cartItems.map(item => (
                  <div key={item.product_id} className="flex items-center mb-4 border-b pb-4">
                    <img
                      src={item.product.image}
                      alt={item.product.name}
                      className="w-20 h-20 object-cover rounded"
                    />
                    <div className="ml-4 flex-1">
                      <h3 className="font-semibold">{item.product.name}</h3>
                      <p className="text-pink-500">Â¥{item.product.price}</p>
                      <div className="flex items-center mt-2">
                        <button
                          className="px-2 py-1 border rounded"
                          onClick={() => updateQuantity(item.product_id, item.quantity - 1)}
                        >
                          -
                        </button>
                        <span className="mx-2">{item.quantity}</span>
                        <button
                          className="px-2 py-1 border rounded"
                          onClick={() => updateQuantity(item.product_id, item.quantity + 1)}
                        >
                          +
                        </button>
                        <button
                          className="ml-4 text-red-500"
                          onClick={() => removeFromCart(item.product_id)}
                        >
                          åˆ é™¤
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
                <div className="fixed bottom-16 left-0 right-0 bg-white p-4 border-t">
                  <div className="flex justify-between items-center">
                    <div className="text-xl font-bold">
                      æ€»è®¡: <span className="text-pink-500">Â¥{total.toFixed(2)}</span>
                    </div>
                    <button className="bg-pink-500 text-white px-6 py-2 rounded-lg">
                      ç»“ç®—
                    </button>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      );
    };

    // ä¸ªäººä¸­å¿ƒé¡µé¢
    const ProfilePage = () => {
      const menuItems = [
        { icon: "ğŸ“¦", title: "æˆ‘çš„è®¢å•" },
        { icon: "â¤ï¸", title: "æˆ‘çš„æ”¶è—" },
        { icon: "ğŸ“", title: "æ”¶è´§åœ°å€" },
        { icon: "ğŸ«", title: "ä¼˜æƒ åˆ¸" },
        { icon: "âš™ï¸", title: "è®¾ç½®" },
        { icon: "â“", title: "å¸®åŠ©ä¸­å¿ƒ" }
      ];

      return (
        <div className="pb-16">
          <div className="bg-pink-500 text-white p-6">
            <div className="flex items-center">
              <div className="w-16 h-16 bg-white rounded-full overflow-hidden">
                <img
                  src="https://images.unsplash.com/photo-1494790108377-be9c29b29330"
                  alt="å¤´åƒ"
                  className="w-full h-full object-cover"
                />
              </div>
              <div className="ml-4">
                <h2 className="text-xl font-bold">ç”¨æˆ·å</h2>
                <p className="text-pink-200">ä¼šå‘˜ç­‰çº§: é»„é‡‘ä¼šå‘˜</p>
              </div>
            </div>
          </div>
          <div className="bg-white mt-4">
            {menuItems.map((item, index) => (
              <div
                key={index}
                className="flex items-center p-4 border-b"
              >
                <span className="text-xl mr-4">{item.icon}</span>
                <span>{item.title}</span>
                <span className="ml-auto text-gray-400">â€º</span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // å•†å“è¯¦æƒ…é¡µé¢
    const ProductDetail = ({ product, onClose }) => {
      const { addToCart } = React.useContext(CartContext);

      return (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
          <div className="relative">
            <button
              className="absolute top-4 left-4 z-10 bg-white rounded-full p-2 shadow"
              onClick={onClose}
            >
              â†
            </button>
            <img
              src={product.image}
              alt={product.name}
              className="w-full h-96 object-cover"
            />
            <div className="p-4">
              <h1 className="text-2xl font-bold">{product.name}</h1>
              <p className="text-pink-500 text-xl font-bold mt-2">Â¥{product.price}</p>
              <p className="text-gray-600 mt-4">{product.description}</p>
              <div className="mt-6 space-y-4">
                <button
                  className="w-full bg-pink-500 text-white py-3 rounded-lg"
                  onClick={() => {
                    addToCart(product);
                    onClose();
                  }}
                >
                  åŠ å…¥è´­ç‰©è½¦
                </button>
                <button className="w-full border border-pink-500 text-pink-500 py-3 rounded-lg">
                  ç«‹å³è´­ä¹°
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ä¸»é¡µé¢
    const HomePage = ({ products, onProductClick }) => {
      const recommendedProducts = products.filter(p => p.isRecommended);
      
      return (
        <div className="pb-16">
          <Carousel items={recommendedProducts} />
          <div className="product-grid">
            {products.map(product => (
              <ProductCard 
                key={product.id} 
                product={product}
                onProductClick={onProductClick}
              />
            ))}
          </div>
        </div>
      );
    };

    // åº•éƒ¨å¯¼èˆªç»„ä»¶
    const BottomNav = ({ activeTab, setActiveTab }) => (
      <div className="bottom-nav grid grid-cols-4 py-2">
        <button 
          onClick={() => setActiveTab('home')}
          className={`flex flex-col items-center ${activeTab === 'home' ? 'text-pink-500' : 'text-gray-500'}`}
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          <span className="text-xs">é¦–é¡µ</span>
        </button>
        <button 
          onClick={() => setActiveTab('category')}
          className={`flex flex-col items-center ${activeTab === 'category' ? 'text-pink-500' : 'text-gray-500'}`}
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
          <span className="text-xs">åˆ†ç±»</span>
        </button>
        <button 
          onClick={() => setActiveTab('cart')}
          className={`flex flex-col items-center ${activeTab === 'cart' ? 'text-pink-500' : 'text-gray-500'}`}
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span className="text-xs">è´­ç‰©è½¦</span>
        </button>
        <button 
          onClick={() => setActiveTab('profile')}
          className={`flex flex-col items-center ${activeTab === 'profile' ? 'text-pink-500' : 'text-gray-500'}`}
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span className="text-xs">æˆ‘çš„</span>
        </button>
      </div>
    );

    // ä¸»åº”ç”¨ç»„ä»¶
    const App = () => {
      const [activeTab, setActiveTab] = useState('home');
      const [selectedProduct, setSelectedProduct] = useState(null);
      
      const { data: products, isLoading } = useQuery({
        queryKey: ['products'],
        queryFn: async () => {
          const apiClient = await getApiClient();
          return apiClient.database.table('products').select('*');
        }
      });

      useEffect(() => {
        initDatabase();
      }, []);

      if (isLoading) {
        return (
          <div className="flex justify-center items-center h-screen">
            <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
          </div>
        );
      }

      const renderContent = () => {
        switch (activeTab) {
          case 'home':
            return <HomePage products={products} onProductClick={setSelectedProduct} />;
          case 'category':
            return <CategoryPage products={products} />;
          case 'cart':
            return <CartPage />;
          case 'profile':
            return <ProfilePage />;
          default:
            return null;
        }
      };

      return (
        <CartProvider>
          <div className="min-h-screen">
            {/* é¡¶éƒ¨æœç´¢æ  */}
            <div className="sticky top-0 bg-white shadow-sm p-4 z-40">
              <div className="relative">
                <input
                  type="search"
                  placeholder="æœç´¢å•†å“"
                  className="w-full px-4 py-2 rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500"
                />
                <svg className="w-5 h-5 absolute right-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>

            {/* ä¸»å†…å®¹åŒºåŸŸ */}
            {renderContent()}

            {/* å•†å“è¯¦æƒ…å¼¹çª— */}
            {selectedProduct && (
              <ProductDetail
                product={selectedProduct}
                onClose={() => setSelectedProduct(null)}
              />
            )}

            {/* åº•éƒ¨å¯¼èˆª */}
            <BottomNav activeTab={activeTab} setActiveTab={setActiveTab} />
          </div>
        </CartProvider>
      );
    };

    // æ¸²æŸ“åº”ç”¨
    const root = createRoot(document.getElementById('root'));
    root.render(
      <QueryClientProvider client={queryClient}>
        <App />
      </QueryClientProvider>
    );
  </script>
</body>
</html> 